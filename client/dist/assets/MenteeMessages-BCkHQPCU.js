import{r as o,S as H,d as J,a as K,b as Q,R as W,j as n,e as f,L as R,F as A,f as M,n as X,g as Z,o as ee,s as S}from"./index-BH-Ykf6z.js";import{C as te,E as se,M as ae,d as ne,a as ie,b as oe,c as ce}from"./Close-CWRMxvyb.js";import{d as F}from"./VideoChat-CTGLVnZg.js";/* empty css                     */import"./generateUtilityClasses-HJM5CisE.js";import"./emotion-react.browser.esm-ZdKyTOPI.js";import"./createSvgIcon-BIW1WnVJ.js";import"./createSvgIcon-LLNz0GyT.js";import"./useTimeout-BKMNU8Hp.js";import"./ownerWindow-D1Z5qid2.js";import"./sweetalert2.all-D9aI5KS5.js";import"./index-DYTiCvF8.js";import"./no-profile-image-7REqqSE_.js";const be=()=>{const i=o.useContext(H),m=J(),[$,C]=o.useState([]),[s,B]=o.useState(null),{user:e}=K(t=>t.userAuth),{mentorId:v,menteeID:I}=Q(),[p,x]=o.useState([]),[u,N]=o.useState(""),[y,O]=o.useState(null),b=W.useRef(null),[j,P]=o.useState(!1),[D,_]=o.useState(),[w,T]=o.useState("");o.useEffect(()=>{var a;const t=s==null?void 0:s.members.find(c=>c!==(e==null?void 0:e._id));(a=i==null?void 0:i.current)==null||a.emit("typing",t)},[u]),o.useEffect(()=>{var a;const t=s==null?void 0:s.members.find(c=>c!==(e==null?void 0:e._id));(a=i==null?void 0:i.current)==null||a.emit("notTyping",t)},[u]),o.useEffect(()=>{var t;(t=i==null?void 0:i.current)==null||t.on("getTyping",()=>{console.log("Typing...")})},[]),o.useEffect(()=>{var t;(t=i==null?void 0:i.current)==null||t.on("getMessage",a=>{O(a)})},[i==null?void 0:i.current]),o.useEffect(()=>{var t;(t=i==null?void 0:i.current)==null||t.on("getMessageDeleted",a=>{const c=p.map(d=>d._id===a?{...d,IsDeleted:!0}:d);x(c)})},[p,i]),o.useEffect(()=>{(async()=>{var a;try{if((await m.post("chat/conversation",{receiverId:v||I,senderId:e==null?void 0:e._id},{withCredentials:!0})).data)if(v){const d=await m.get(`chat/mentee/conversation/${e==null?void 0:e._id}/${v}`,{withCredentials:!0});d.data&&(C(d.data.conversation),B((a=d.data.conversation)==null?void 0:a[0]))}else{const d=await m.get(`chat/mentor/conversation/${e==null?void 0:e._id}/${I}`,{withCredentials:!0});d.data&&(C(d.data.conversation),B(d.data.conversation[0]))}}catch(c){console.log(c)}})()},[m,I,v,e==null?void 0:e._id]),o.useEffect(()=>{y&&(s!=null&&s.members.includes(y==null?void 0:y.senderId))&&x(t=>[...t,y])},[y,s,s==null?void 0:s.members]),o.useEffect(()=>{try{(async()=>{const a=await m.get(`chat/allConversation/${s==null?void 0:s._id}`);a.data&&x(a.data.messages)})()}catch(t){console.log(t)}},[$,m,e==null?void 0:e._id,s==null?void 0:s._id,s]);const k=async t=>{var a,c,d;if(t.preventDefault(),!(!u&&!w))try{if(D&&w){const r={senderId:e==null?void 0:e._id,text:w,conversationId:s==null?void 0:s._id,type:"image"},h=s==null?void 0:s.members.find(g=>g!==(e==null?void 0:e._id)),l=await m.post("chat/message",r,{withCredentials:!0});l&&((a=i==null?void 0:i.current)==null||a.emit("sendMessage",{...l.data.savedMessage,receiverId:h}),x([...p,l.data.savedMessage]),T(""),_(!1))}if(u){const r={senderId:e==null?void 0:e._id,text:u,conversationId:s==null?void 0:s._id,type:"text"},h=s==null?void 0:s.members.find(g=>g!==(e==null?void 0:e._id)),l=await m.post("chat/message",r,{withCredentials:!0});l&&((c=i==null?void 0:i.current)==null||c.emit("sendMessage",{...l.data.savedMessage,receiverId:h})),x([...p,l.data.savedMessage]),N("")}try{const r=s==null?void 0:s.members.find(g=>g!==(e==null?void 0:e._id)),h={userId:r,content:"You have New Message ðŸ””",role:(e==null?void 0:e.role)==="mentee"?"mentor":"mentee",messageType:"new chat",senderId:e==null?void 0:e._id};(await m.post(`/notification/chatNotification/${e==null?void 0:e._id}`,{ChatMessage:h},{withCredentials:!0})).data.status==="success"?(d=i==null?void 0:i.current)==null||d.emit("sendNotification",{senderId:e==null?void 0:e._id,receiverId:r,content:"You have a New Message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(r){console.log(r)}}catch(r){console.log(r)}};o.useEffect(()=>{var t;(t=b==null?void 0:b.current)==null||t.scrollIntoView({behavior:"smooth"})},[p]);const U=()=>{P(t=>!t)},L=t=>{const a=document.getElementById("imoji-btn"),c=document.getElementById("imoji-picker");a&&c&&!a.contains(t==null?void 0:t.target)&&!c.contains(t==null?void 0:t.target)&&P(!1)};o.useEffect(()=>(j&&window.addEventListener("click",L),()=>{window.removeEventListener("click",L)}),[j]);const V=t=>{const a=t.emoji;a?N(c=>c+a):console.log("emoji is not available")},Y=async t=>{var a;if(t.target.files){const c=t.target.files[0],d=new Blob([c],{type:c.type}),r=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),h=M(S,r),l=await X(h,d);if(l){const g=(a=l.metadata)==null?void 0:a.fullPath;if(T(g),g){const z=M(S,g);_(!0),Z(z).then(E=>{const G=document.getElementById("chat_img_main");G.src=E}).catch(E=>{console.log(E)})}}t.target.value=""}},q=()=>{const t=M(S,w);ee(t).then(()=>{_(!1)}).catch(a=>{console.log("Error Occured",a)})};return o.useEffect(()=>{_(!1)},[]),o.useEffect(()=>{var t;(t=b.current)==null||t.scrollIntoView({behavior:"smooth"})},[p]),n(A,{children:f("div",{className:"grid grid-cols-12 h-full bg-background-two",children:[n("div",{className:"col-span-3"}),n("div",{className:"col-span-12 md:col-span-8 bg-gray-800 rounded-md",children:f("div",{className:"flex flex-col items-center justify-center w-full min-h-screen text-gray-800 rounded",children:[n("div",{className:"w-full",id:"chat_header",children:n("div",{children:$.map((t,a)=>f("div",{className:"flex",children:[n(te,{conversation:t,currentUser:e,index:a}),f("div",{className:"flex justify-center items-center px-4",children:[(e==null?void 0:e.role)==="mentee"&&n(R,{to:`/video/${v}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:n(F,{className:"text-gray-200"})}),(e==null?void 0:e.role)==="mentor"&&n(A,{children:n(R,{to:`/video/${I}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:n(F,{})})})]})]},a))})}),n("div",{id:"imoji-picker",children:j&&n(se,{onEmojiClick:V})}),f("div",{className:"flex flex-col flex-grow w-full bg-green shadow-xl rounded-lg overflow-hidden",children:[n("div",{className:"flex flex-col flex-grow h-0 p-4 overflow-auto",children:p.map((t,a)=>n("div",{ref:b,children:n(ae,{message:t,own:(t==null?void 0:t.senderId)===(e==null?void 0:e._id),index:a,currentChat:s,userId:e==null?void 0:e._id})},a))}),D?f("div",{className:"bg-gray-100 border-2 flex justify-center px-3 py-3",children:[n("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),n("span",{className:"px-2 cursor-pointer",onClick:q,children:n(ne,{className:"border-2 rounded"})})]}):"",f("div",{className:"flex items-center px-1 w-full mb-4",children:[f("div",{className:"px-2 hover:bg-gray-300 rounded-full",children:[n("span",{className:"hidden",children:n("input",{type:"file",src:w||"",id:"imageFile",onChange:Y})}),n("span",{onClick:()=>{var t;(t=document.getElementById("imageFile"))==null||t.click()},children:n(ie,{className:"text-gray-400"})})]}),n("input",{type:"text",id:"messageInput",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2 bg-gray-800 text-white",value:u,onChange:t=>N(t.target.value)}),n("div",{children:n("span",{className:"px-2 py-2",onClick:U,id:"imoji-btn",children:n(oe,{className:"text-gray-400"})})}),n("div",{className:"bg-gray-800 rounded-r h-10 flex items-center px-2 cursor-pointer hover:bg-slate-300",onClick:k,children:n(ce,{className:"text-gray-400"})})]})]})]})}),n("div",{className:"col-span-3"})]})})};export{be as default};
