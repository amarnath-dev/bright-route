import{r as c,S as J,d as K,a as Q,b as W,R as X,j as n,e as f,L as A,F,f as E,n as Z,g as ee,o as te,s as S}from"./index-Cm1l80VI.js";import{C as se,E as ae,M as ne,d as oe,a as ie,b as ce,c as de}from"./Close-CpZDz3Ng.js";import{d as L}from"./VideoChat-BAdQjtjO.js";/* empty css                     */import"./generateUtilityClasses-CbuUGrSe.js";import"./emotion-react.browser.esm-EPQkPldl.js";import"./createSvgIcon-ZfMzdwQK.js";import"./createSvgIcon-CUMYJe6H.js";import"./useTimeout-BfMRyHkY.js";import"./ownerWindow-B806um-j.js";import"./sweetalert2.all-aYo_8JHa.js";import"./index-ByZ0f9l0.js";const Ie=()=>{const o=c.useContext(J),m=K(),[$,C]=c.useState([]),[s,P]=c.useState(null),{user:e}=Q(t=>t.userAuth),{mentorId:u,menteeID:b}=W(),[p,w]=c.useState([]),[h,N]=c.useState(""),[y,R]=c.useState(null),I=X.useRef(null),[M,T]=c.useState(!1),[B,_]=c.useState(),[x,D]=c.useState("");c.useEffect(()=>{var a;const t=s==null?void 0:s.members.find(i=>i!==(e==null?void 0:e._id));(a=o==null?void 0:o.current)==null||a.emit("typing",t)},[h]),c.useEffect(()=>{var t;h||(t=o==null?void 0:o.current)==null||t.emit("notTyping",s==null?void 0:s.members)},[h]),c.useEffect(()=>{var t;console.log("Get typing is running..."),(t=o==null?void 0:o.current)==null||t.on("getTyping",()=>{console.log("TYPING...")})},[]),c.useEffect(()=>{var t;(t=o==null?void 0:o.current)==null||t.on("getMessage",a=>{console.log("Arrival Message -> ",a),R(a)})},[o==null?void 0:o.current]),c.useEffect(()=>{(async()=>{var a;try{if((await m.post("chat/conversation",{receiverId:u||b,senderId:e==null?void 0:e._id},{withCredentials:!0})).data)if(u){const d=await m.get(`chat/mentee/conversation/${e==null?void 0:e._id}/${u}`,{withCredentials:!0});console.log("-->",d.data),d.data&&(C(d.data.conversation),P((a=d.data.conversation)==null?void 0:a[0]))}else{const d=await m.get(`chat/mentor/conversation/${e==null?void 0:e._id}/${b}`,{withCredentials:!0});d.data&&(C(d.data.conversation),P(d.data.conversation[0]))}}catch(i){console.log(i)}})()},[m,b,u,e==null?void 0:e._id]),c.useEffect(()=>{y&&(s!=null&&s.members.includes(y==null?void 0:y.senderId))&&w(t=>[...t,y])},[y,s,s==null?void 0:s.members]),c.useEffect(()=>{try{(async()=>{const a=await m.get(`chat/allConversation/${s==null?void 0:s._id}`);a.data&&w(a.data.messages)})()}catch(t){console.log(t)}},[$,m,e==null?void 0:e._id,s==null?void 0:s._id,s]);const O=async t=>{var a,i,d;if(t.preventDefault(),!(!h&&!x))try{if(B&&x){const l={senderId:e==null?void 0:e._id,text:x,conversationId:s==null?void 0:s._id,type:"image"},v=s==null?void 0:s.members.find(g=>g!==(e==null?void 0:e._id)),r=await m.post("chat/message",l,{withCredentials:!0});r&&((a=o==null?void 0:o.current)==null||a.emit("sendMessage",{...r.data.savedMessage,receiverId:v}),w([...p,r.data.savedMessage]),D(""),_(!1))}if(h){const l={senderId:e==null?void 0:e._id,text:h,conversationId:s==null?void 0:s._id,type:"text"},v=s==null?void 0:s.members.find(g=>g!==(e==null?void 0:e._id)),r=await m.post("chat/message",l,{withCredentials:!0});r&&((i=o==null?void 0:o.current)==null||i.emit("sendMessage",{...r.data.savedMessage,receiverId:v})),w([...p,r.data.savedMessage]),N("")}try{const l=s==null?void 0:s.members.find(g=>g!==(e==null?void 0:e._id)),v={userId:l,content:"You have New Message ðŸ””",role:(e==null?void 0:e.role)==="mentee"?"mentor":"mentee",messageType:"new chat",senderId:e==null?void 0:e._id};(await m.post(`/notification/chatNotification/${e==null?void 0:e._id}`,{ChatMessage:v},{withCredentials:!0})).data.status==="success"?(d=o==null?void 0:o.current)==null||d.emit("sendNotification",{senderId:e==null?void 0:e._id,receiverId:l,content:"You have a New Message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(l){console.log(l)}}catch(l){console.log(l)}};c.useEffect(()=>{var t;(t=I==null?void 0:I.current)==null||t.scrollIntoView({behavior:"smooth"})},[p]);const Y=()=>{T(t=>!t)},k=t=>{const a=document.getElementById("imoji-btn"),i=document.getElementById("imoji-picker");a&&i&&!a.contains(t==null?void 0:t.target)&&!i.contains(t==null?void 0:t.target)&&T(!1)};c.useEffect(()=>(M&&window.addEventListener("click",k),()=>{window.removeEventListener("click",k)}),[M]);const G=t=>{const a=t.emoji;a?N(i=>i+a):console.log("emoji is not available")},U=async t=>{var a;if(t.target.files){const i=t.target.files[0],d=new Blob([i],{type:i.type}),l=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),v=E(S,l),r=await Z(v,d);if(r){const g=(a=r.metadata)==null?void 0:a.fullPath;if(D(g),g){const z=E(S,g);_(!0),ee(z).then(j=>{const H=document.getElementById("chat_img_main");H.src=j}).catch(j=>{console.log(j)})}}t.target.value=""}},V=()=>{const t=E(S,x);te(t).then(()=>{_(!1)}).catch(a=>{console.log("Error Occured",a)})};c.useEffect(()=>{_(!1)},[]);const q=t=>{console.log("Menteee "),console.log("My parent mentee, deletd id -> ",t);const a=p.findIndex(i=>i._id===t);if(a>=0){const i=[...p];i[a]={...i[a],IsDeleted:!0},w(i)}};return c.useEffect(()=>{var t;(t=I.current)==null||t.scrollIntoView({behavior:"smooth"})},[p]),n(F,{children:f("div",{className:"grid grid-cols-12 h-full bg-background-two",children:[n("div",{className:"col-span-3"}),n("div",{className:"col-span-12 md:col-span-8 bg-gray-800 rounded-md",children:f("div",{className:"flex flex-col items-center justify-center w-full min-h-screen text-gray-800 rounded",children:[n("div",{className:"w-full",id:"chat_header",children:n("div",{children:$.map((t,a)=>f("div",{className:"flex",children:[n(se,{conversation:t,currentUser:e,index:a}),f("div",{className:"flex justify-center items-center px-4",children:[(e==null?void 0:e.role)==="mentee"&&n(A,{to:`/video/${u}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:n(L,{className:"text-gray-200"})}),(e==null?void 0:e.role)==="mentor"&&n(F,{children:n(A,{to:`/video/${b}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:n(L,{})})})]})]},a))})}),n("div",{id:"imoji-picker",children:M&&n(ae,{onEmojiClick:G})}),f("div",{className:"flex flex-col flex-grow w-full bg-green shadow-xl rounded-lg overflow-hidden",children:[n("div",{className:"flex flex-col flex-grow h-0 p-4 overflow-auto",children:p.map((t,a)=>n("div",{ref:I,children:n(ne,{paretnType:"mentee",sendDataToParent:q,message:t,own:(t==null?void 0:t.senderId)===(e==null?void 0:e._id),index:a,currentChat:s,userId:e==null?void 0:e._id})},a))}),B?f("div",{className:"bg-gray-100 border-2 flex justify-center px-3 py-3",children:[n("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),n("span",{className:"px-2 cursor-pointer",onClick:V,children:n(oe,{className:"border-2 rounded"})})]}):"",f("div",{className:"flex items-center px-1 w-full mb-4",children:[f("div",{className:"px-2 hover:bg-gray-300 rounded-full",children:[n("span",{className:"hidden",children:n("input",{type:"file",src:x||"",id:"imageFile",onChange:U})}),n("span",{onClick:()=>{var t;(t=document.getElementById("imageFile"))==null||t.click()},children:n(ie,{className:"text-gray-400"})})]}),n("input",{type:"text",id:"messageInput",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2 bg-gray-800 text-white",value:h,onChange:t=>N(t.target.value)}),n("div",{children:n("span",{className:"px-2 py-2",onClick:Y,id:"imoji-btn",children:n(ce,{className:"text-gray-400"})})}),n("div",{className:"bg-gray-800 rounded-r h-10 flex items-center px-2 cursor-pointer hover:bg-slate-300",onClick:O,children:n(de,{className:"text-gray-400"})})]})]})]})}),n("div",{className:"col-span-3"})]})})};export{Ie as default};
