import{d as Y,r as i,a as q,h as z,R as G,j as t,i as M,n as H,k as J,x as K,l as N}from"./index-0cbBuzyu.js";import{C as Q,E as W,M as X,d as Z,a as ee,b as se,c as te}from"./Close-AQ-KnW5V.js";import{l as ae}from"./index-CUx-uIXr.js";import"./createSvgIcon-6kS-rPVs.js";import"./createSvgIcon-F78VQwd9.js";import"./useThemeProps-fGDrEsnV.js";import"./sweetalert2.all-yZvuN_lf.js";import"./index-ockJPBQZ.js";const ge=()=>{const r=Y(),[k,C]=i.useState([]),[o,S]=i.useState(null),{user:e}=q(s=>s.userAuth),{mentorId:p,menteeID:I}=z(),[x,u]=i.useState([]),[v,y]=i.useState(""),[f,A]=i.useState(null),_=G.useRef(null),m=i.useRef(null),[b,$]=i.useState(!1),[R,j]=i.useState(),[h,B]=i.useState("");i.useEffect(()=>{var s;m.current=ae("ws://localhost:3000"),(s=m.current)==null||s.on("getMessage",a=>{console.log("Arrival Message",a),A(a)})},[]),i.useEffect(()=>{var s,a;(s=m.current)==null||s.emit("addUser",e==null?void 0:e._id),(a=m.current)==null||a.on("getUsers",n=>{console.log(n)})},[e]),i.useEffect(()=>{(async()=>{try{if((await r.post("chat/conversation",{receiverId:p||I,senderId:e==null?void 0:e._id},{withCredentials:!0})).data)if(p){const n=await r.get(`chat/mentee/conversation/${e==null?void 0:e._id}/${p}`,{withCredentials:!0});n.data&&(C(n.data.conversation),S(n.data.conversation[0]))}else{const n=await r.get(`chat/mentor/conversation/${e==null?void 0:e._id}/${I}`,{withCredentials:!0});n.data&&(C(n.data.conversation),S(n.data.conversation[0]))}}catch(a){console.log(a)}})()},[r,I,p,e==null?void 0:e._id]),i.useEffect(()=>{f&&(o!=null&&o.members.includes(f==null?void 0:f.senderId))&&u(s=>[...s,f])},[f,o]),i.useEffect(()=>{try{(async()=>{const a=await r.get(`chat/allConversation/${o==null?void 0:o._id}`);a.data&&u(a.data.allMessages)})()}catch(s){console.log(s)}},[k,r,e==null?void 0:e._id,o==null?void 0:o._id,o]);const D=async s=>{var a,n,w;if(s.preventDefault(),!(!v&&!h))try{if(R&&h){const c={senderId:e==null?void 0:e._id,text:h,conversationId:o==null?void 0:o._id,type:"image"},g=o==null?void 0:o.members.find(d=>d!==(e==null?void 0:e._id)),l=await r.post("chat/message",c,{withCredentials:!0});l&&((a=m.current)==null||a.emit("sendMessage",{...l.data.savedMessage,receiverId:g}),u([...x,l.data.savedMessage]),B(""),j(!1))}if(v){const c={senderId:e==null?void 0:e._id,text:v,conversationId:o==null?void 0:o._id,type:"text"},g=o==null?void 0:o.members.find(d=>d!==(e==null?void 0:e._id)),l=await r.post("chat/message",c,{withCredentials:!0});l&&((n=m.current)==null||n.emit("sendMessage",{...l.data.savedMessage,receiverId:g})),u([...x,l.data.savedMessage]),y("")}try{const c=o==null?void 0:o.members.find(d=>d!==(e==null?void 0:e._id)),g={userId:c,content:"You have one new Message!!ðŸ””",role:"mentor",messageType:"new chat",senderId:e==null?void 0:e._id};await r.post(`/notification/chatNotification/${e==null?void 0:e._id}`,{ChatMessage:g},{withCredentials:!0})?(w=m.current)==null||w.emit("sendNotification",{senderId:e==null?void 0:e._id,receiverId:c,content:"You have a new message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(c){console.log(c)}}catch(c){console.log(c)}};i.useEffect(()=>{var s;(s=_.current)==null||s.scrollIntoView({behavior:"smooth"})},[x]);const O=()=>{$(s=>!s)},P=s=>{const a=document.getElementById("imoji-btn"),n=document.getElementById("imoji-picker");a&&n&&!a.contains(s==null?void 0:s.target)&&!n.contains(s==null?void 0:s.target)&&$(!1)};i.useEffect(()=>(b&&window.addEventListener("click",P),()=>{window.removeEventListener("click",P)}),[b]);const U=s=>{const a=s.emoji;a?y(n=>n+a):console.log("emoji is not available")},F=async s=>{var a;if(s.target.files){const n=s.target.files[0],w=new Blob([n],{type:n.type}),c=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),g=M(N,c),l=await H(g,w);if(l){const d=(a=l.metadata)==null?void 0:a.fullPath;if(B(d),d){const T=M(N,d);j(!0),J(T).then(E=>{const V=document.getElementById("chat_img_main");V.src=E}).catch(E=>{console.log(E)})}}s.target.value=""}},L=()=>{const s=M(N,h);K(s).then(()=>{j(!1)}).catch(a=>{console.log("Error Occured",a)})};return i.useEffect(()=>{j(!1)},[]),i.useEffect(()=>{var s;(s=_.current)==null||s.scrollIntoView({behavior:"smooth"})},[x]),t.jsx(t.Fragment,{children:t.jsxs("div",{className:"grid grid-cols-12 h-full bg-gray-200",children:[t.jsx("div",{className:"col-span-3 px-1 py-1"}),t.jsx("div",{className:"col-span-12 md:col-span-6 bg-white rounded-md",children:t.jsxs("div",{className:"flex flex-col items-center justify-center w-full min-h-screen text-gray-800 rounded",children:[t.jsx("div",{className:"w-full",id:"chat_header",children:k.map((s,a)=>t.jsx("div",{children:t.jsx(Q,{conversation:s,currentUser:e,index:a})},a))}),t.jsx("div",{id:"imoji-picker",children:b&&t.jsx(W,{onEmojiClick:U})}),t.jsxs("div",{className:"flex flex-col flex-grow w-full bg-green shadow-xl rounded-lg overflow-hidden",children:[t.jsx("div",{className:"flex flex-col flex-grow h-0 p-4 overflow-auto",children:x.map((s,a)=>t.jsx("div",{ref:_,children:t.jsx(X,{message:s,own:(s==null?void 0:s.senderId)===(e==null?void 0:e._id),index:a,currentChat:o,userId:e==null?void 0:e._id})},a))}),R?t.jsxs("div",{className:"bg-gray-100 border-2 flex justify-center px-3 py-3",children:[t.jsx("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),t.jsx("span",{className:"px-2 cursor-pointer",onClick:L,children:t.jsx(Z,{className:"border-2 rounded"})})]}):"",t.jsxs("div",{className:"flex items-center px-1 w-full mb-4",children:[t.jsxs("div",{className:"px-2 hover:bg-gray-300 rounded-full",children:[t.jsx("span",{className:"hidden",children:t.jsx("input",{type:"file",src:h||"",id:"imageFile",onChange:F})}),t.jsx("span",{onClick:()=>{var s;(s=document.getElementById("imageFile"))==null||s.click()},children:t.jsx(ee,{})})]}),t.jsx("input",{type:"text",id:"messageInput",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2",value:v,onChange:s=>y(s.target.value)}),t.jsx("div",{children:t.jsx("span",{className:"px-2 py-2",onClick:O,id:"imoji-btn",children:t.jsx(se,{})})}),t.jsx("div",{className:"bg-gray-200 rounded-r h-10 flex items-center px-2 cursor-pointer hover:bg-slate-300",onClick:D,children:t.jsx(te,{})})]})]})]})}),t.jsx("div",{className:"col-span-3"})]})})};export{ge as default};
