import{r as i,S as H,d as J,a as K,b as Q,R as W,j as n,e as f,L,F as R,f as M,n as X,g as Z,o as ee,s as S}from"./index-VB1ztP5L.js";import{C as se,E as te,M as ae,d as ne,a as oe,b as ie,c as ce}from"./Close-RP9M_EqB.js";import{d as D}from"./VideoChat-WzC1Tt8s.js";/* empty css                     */import"./generateUtilityClasses-Xcbp_17J.js";import"./emotion-react.browser.esm-og8XBY_v.js";import"./createSvgIcon-i2M50TJl.js";import"./createSvgIcon-CWqY05YG.js";import"./useTimeout-LW8nS8R1.js";import"./ownerWindow-lrf5Pgpu.js";import"./sweetalert2.all-q7W9uBhn.js";import"./index-yYOzs5gN.js";const xe=()=>{const o=i.useContext(H),m=J(),[$,C]=i.useState([]),[t,P]=i.useState(null),{user:e}=K(s=>s.userAuth),{mentorId:v,menteeID:b}=Q(),[w,I]=i.useState([]),[p,_]=i.useState(""),[u,F]=i.useState(null),x=W.useRef(null),[j,B]=i.useState(!1),[T,N]=i.useState(),[y,k]=i.useState("");i.useEffect(()=>{var a;const s=t==null?void 0:t.members.find(c=>c!==(e==null?void 0:e._id));(a=o==null?void 0:o.current)==null||a.emit("typing",s)},[p]),i.useEffect(()=>{var s;p||(s=o==null?void 0:o.current)==null||s.emit("notTyping",t==null?void 0:t.members)},[p]),i.useEffect(()=>{var s;console.log("Get typing is running..."),(s=o==null?void 0:o.current)==null||s.on("getTyping",()=>{console.log("TYPING...")})},[]),i.useEffect(()=>{var s;(s=o==null?void 0:o.current)==null||s.on("getMessage",a=>{console.log("Arrival Message -> ",a),F(a)})},[o==null?void 0:o.current]),i.useEffect(()=>{(async()=>{var a;try{if((await m.post("chat/conversation",{receiverId:v||b,senderId:e==null?void 0:e._id},{withCredentials:!0})).data)if(v){const l=await m.get(`chat/mentee/conversation/${e==null?void 0:e._id}/${v}`,{withCredentials:!0});console.log("-->",l.data),l.data&&(C(l.data.conversation),P((a=l.data.conversation)==null?void 0:a[0]))}else{const l=await m.get(`chat/mentor/conversation/${e==null?void 0:e._id}/${b}`,{withCredentials:!0});l.data&&(C(l.data.conversation),P(l.data.conversation[0]))}}catch(c){console.log(c)}})()},[m,b,v,e==null?void 0:e._id]),i.useEffect(()=>{u&&(t!=null&&t.members.includes(u==null?void 0:u.senderId))&&I(s=>[...s,u])},[u,t,t==null?void 0:t.members]),i.useEffect(()=>{try{(async()=>{const a=await m.get(`chat/allConversation/${t==null?void 0:t._id}`);a.data&&I(a.data.allMessages)})()}catch(s){console.log(s)}},[$,m,e==null?void 0:e._id,t==null?void 0:t._id,t]);const O=async s=>{var a,c,l;if(s.preventDefault(),!(!p&&!y))try{if(T&&y){const d={senderId:e==null?void 0:e._id,text:y,conversationId:t==null?void 0:t._id,type:"image"},h=t==null?void 0:t.members.find(g=>g!==(e==null?void 0:e._id)),r=await m.post("chat/message",d,{withCredentials:!0});r&&((a=o==null?void 0:o.current)==null||a.emit("sendMessage",{...r.data.savedMessage,receiverId:h}),I([...w,r.data.savedMessage]),k(""),N(!1))}if(p){const d={senderId:e==null?void 0:e._id,text:p,conversationId:t==null?void 0:t._id,type:"text"},h=t==null?void 0:t.members.find(g=>g!==(e==null?void 0:e._id)),r=await m.post("chat/message",d,{withCredentials:!0});r&&((c=o==null?void 0:o.current)==null||c.emit("sendMessage",{...r.data.savedMessage,receiverId:h})),I([...w,r.data.savedMessage]),_("")}try{const d=t==null?void 0:t.members.find(g=>g!==(e==null?void 0:e._id)),h={userId:d,content:"You have New Message ðŸ””",role:(e==null?void 0:e.role)==="mentee"?"mentor":"mentee",messageType:"new chat",senderId:e==null?void 0:e._id};(await m.post(`/notification/chatNotification/${e==null?void 0:e._id}`,{ChatMessage:h},{withCredentials:!0})).data.status==="success"?(l=o==null?void 0:o.current)==null||l.emit("sendNotification",{senderId:e==null?void 0:e._id,receiverId:d,content:"You have a New Message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(d){console.log(d)}}catch(d){console.log(d)}};i.useEffect(()=>{var s;(s=x==null?void 0:x.current)==null||s.scrollIntoView({behavior:"smooth"})},[w]);const Y=()=>{B(s=>!s)},A=s=>{const a=document.getElementById("imoji-btn"),c=document.getElementById("imoji-picker");a&&c&&!a.contains(s==null?void 0:s.target)&&!c.contains(s==null?void 0:s.target)&&B(!1)};i.useEffect(()=>(j&&window.addEventListener("click",A),()=>{window.removeEventListener("click",A)}),[j]);const G=s=>{const a=s.emoji;a?_(c=>c+a):console.log("emoji is not available")},U=async s=>{var a;if(s.target.files){const c=s.target.files[0],l=new Blob([c],{type:c.type}),d=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),h=M(S,d),r=await X(h,l);if(r){const g=(a=r.metadata)==null?void 0:a.fullPath;if(k(g),g){const q=M(S,g);N(!0),Z(q).then(E=>{const z=document.getElementById("chat_img_main");z.src=E}).catch(E=>{console.log(E)})}}s.target.value=""}},V=()=>{const s=M(S,y);ee(s).then(()=>{N(!1)}).catch(a=>{console.log("Error Occured",a)})};return i.useEffect(()=>{N(!1)},[]),i.useEffect(()=>{var s;(s=x.current)==null||s.scrollIntoView({behavior:"smooth"})},[w]),n(R,{children:f("div",{className:"grid grid-cols-12 h-full bg-background-two",children:[n("div",{className:"col-span-3"}),n("div",{className:"col-span-12 md:col-span-8 bg-gray-800 rounded-md",children:f("div",{className:"flex flex-col items-center justify-center w-full min-h-screen text-gray-800 rounded",children:[n("div",{className:"w-full",id:"chat_header",children:n("div",{children:$.map((s,a)=>f("div",{className:"flex",children:[n(se,{conversation:s,currentUser:e,index:a}),f("div",{className:"flex justify-center items-center px-4",children:[(e==null?void 0:e.role)==="mentee"&&n(L,{to:`/video/${v}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:n(D,{className:"text-gray-200"})}),(e==null?void 0:e.role)==="mentor"&&n(R,{children:n(L,{to:`/video/${b}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:n(D,{})})})]})]},a))})}),n("div",{id:"imoji-picker",children:j&&n(te,{onEmojiClick:G})}),f("div",{className:"flex flex-col flex-grow w-full bg-green shadow-xl rounded-lg overflow-hidden",children:[n("div",{className:"flex flex-col flex-grow h-0 p-4 overflow-auto",children:w.map((s,a)=>n("div",{ref:x,children:n(ae,{message:s,own:(s==null?void 0:s.senderId)===(e==null?void 0:e._id),index:a,currentChat:t,userId:e==null?void 0:e._id})},a))}),T?f("div",{className:"bg-gray-100 border-2 flex justify-center px-3 py-3",children:[n("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),n("span",{className:"px-2 cursor-pointer",onClick:V,children:n(ne,{className:"border-2 rounded"})})]}):"",f("div",{className:"flex items-center px-1 w-full mb-4",children:[f("div",{className:"px-2 hover:bg-gray-300 rounded-full",children:[n("span",{className:"hidden",children:n("input",{type:"file",src:y||"",id:"imageFile",onChange:U})}),n("span",{onClick:()=>{var s;(s=document.getElementById("imageFile"))==null||s.click()},children:n(oe,{className:"text-gray-400"})})]}),n("input",{type:"text",id:"messageInput",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2 bg-gray-800 text-white",value:p,onChange:s=>_(s.target.value)}),n("div",{children:n("span",{className:"px-2 py-2",onClick:Y,id:"imoji-btn",children:n(ie,{className:"text-gray-400"})})}),n("div",{className:"bg-gray-800 rounded-r h-10 flex items-center px-2 cursor-pointer hover:bg-slate-300",onClick:O,children:n(ce,{className:"text-gray-400"})})]})]})]})}),n("div",{className:"col-span-3"})]})})};export{xe as default};
