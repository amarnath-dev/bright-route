import{d as H,r as n,a as q,i as z,R as J,j as t,L as T,k as E,o as K,l as Q,y as W,m as M}from"./index-g0sAwdL0.js";import{C as X,E as Z,M as ee,d as se,a as te,b as ae,c as oe}from"./Close-vKBDFK-E.js";import{l as ne}from"./index-CUx-uIXr.js";import{d as U}from"./VideoChat-LRhkB_vr.js";/* empty css                     */import ie from"./Navbar-EDyPenqm.js";import"./createSvgIcon-aDuf2hYU.js";import"./createSvgIcon-ukait2OE.js";import"./useThemeProps-HKTc5qxQ.js";import"./sweetalert2.all-he3Uarcc.js";import"./index-M1nQObc9.js";import"./Toast-nbcniTx-.js";import"./index-cJD9i2rj.js";const ce="https://bright-route.online",we=()=>{const m=H(),[k,S]=n.useState([]),[a,$]=n.useState(null),{user:e}=q(s=>s.userAuth),{mentorId:p,menteeID:v}=z(),[j,y]=n.useState([]),[u,b]=n.useState(""),[x,A]=n.useState(null),I=J.useRef(null),i=n.useRef(null),[N,C]=n.useState(!1),[R,w]=n.useState(),[h,B]=n.useState("");n.useEffect(()=>{var s,o;i.current=ne(ce),(s=i.current)==null||s.emit("addUser",e==null?void 0:e._id),(o=i.current)==null||o.on("getUsers",c=>{console.log("Current Usres",c)})},[e]),n.useEffect(()=>{var s;(s=i==null?void 0:i.current)==null||s.emit("typing",a==null?void 0:a.members)},[u]),n.useEffect(()=>{var s;(s=i.current)==null||s.on("getTyping",()=>{console.log("TYPING")})},[i.current]),n.useEffect(()=>{var s;console.log("RUNNING>>>",i.current),(s=i==null?void 0:i.current)==null||s.on("getMessage",o=>{console.log("Arrival Message -> ",o),A(o)})},[i==null?void 0:i.current]),n.useEffect(()=>{(async()=>{var o;try{if((await m.post("chat/conversation",{receiverId:p||v,senderId:e==null?void 0:e._id},{withCredentials:!0})).data)if(p){const r=await m.get(`chat/mentee/conversation/${e==null?void 0:e._id}/${p}`,{withCredentials:!0});console.log("-->",r.data),r.data&&(S(r.data.conversation),$((o=r.data.conversation)==null?void 0:o[0]))}else{const r=await m.get(`chat/mentor/conversation/${e==null?void 0:e._id}/${v}`,{withCredentials:!0});console.log("-->",r.data),r.data&&(S(r.data.conversation),$(r.data.conversation[0]))}}catch(c){console.log(c)}})()},[m,v,p,e==null?void 0:e._id]),n.useEffect(()=>{x&&(a!=null&&a.members.includes(x==null?void 0:x.senderId))?y(s=>[...s,x]):console.log("Nop")},[x,a,a==null?void 0:a.members]),n.useEffect(()=>{try{(async()=>{const o=await m.get(`chat/allConversation/${a==null?void 0:a._id}`);o.data&&y(o.data.allMessages)})()}catch(s){console.log(s)}},[k,m,e==null?void 0:e._id,a==null?void 0:a._id,a]);const F=async s=>{var o,c,r;if(s.preventDefault(),!(!u&&!h))try{if(R&&h){const l={senderId:e==null?void 0:e._id,text:h,conversationId:a==null?void 0:a._id,type:"image"},f=a==null?void 0:a.members.find(g=>g!==(e==null?void 0:e._id)),d=await m.post("chat/message",l,{withCredentials:!0});d&&((o=i.current)==null||o.emit("sendMessage",{...d.data.savedMessage,receiverId:f}),y([...j,d.data.savedMessage]),B(""),w(!1))}if(u){const l={senderId:e==null?void 0:e._id,text:u,conversationId:a==null?void 0:a._id,type:"text"},f=a==null?void 0:a.members.find(g=>g!==(e==null?void 0:e._id)),d=await m.post("chat/message",l,{withCredentials:!0});d&&((c=i.current)==null||c.emit("sendMessage",{...d.data.savedMessage,receiverId:f})),y([...j,d.data.savedMessage]),b("")}try{const l=a==null?void 0:a.members.find(g=>g!==(e==null?void 0:e._id)),f={userId:l,content:"You have New Message ðŸ””",role:"mentor",messageType:"new chat",senderId:e==null?void 0:e._id};await m.post(`/notification/chatNotification/${e==null?void 0:e._id}`,{ChatMessage:f},{withCredentials:!0})?(r=i.current)==null||r.emit("sendNotification",{senderId:e==null?void 0:e._id,receiverId:l,content:"You have a New Message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(l){console.log(l)}}catch(l){console.log(l)}};n.useEffect(()=>{var s;(s=I.current)==null||s.scrollIntoView({behavior:"smooth"})},[j]);const L=()=>{C(s=>!s)},P=s=>{const o=document.getElementById("imoji-btn"),c=document.getElementById("imoji-picker");o&&c&&!o.contains(s==null?void 0:s.target)&&!c.contains(s==null?void 0:s.target)&&C(!1)};n.useEffect(()=>(N&&window.addEventListener("click",P),()=>{window.removeEventListener("click",P)}),[N]);const O=s=>{const o=s.emoji;o?b(c=>c+o):console.log("emoji is not available")},D=async s=>{var o;if(s.target.files){const c=s.target.files[0],r=new Blob([c],{type:c.type}),l=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),f=E(M,l),d=await K(f,r);if(d){const g=(o=d.metadata)==null?void 0:o.fullPath;if(B(g),g){const G=E(M,g);w(!0),Q(G).then(_=>{const V=document.getElementById("chat_img_main");V.src=_}).catch(_=>{console.log(_)})}}s.target.value=""}},Y=()=>{const s=E(M,h);W(s).then(()=>{w(!1)}).catch(o=>{console.log("Error Occured",o)})};return n.useEffect(()=>{w(!1)},[]),n.useEffect(()=>{var s;(s=I.current)==null||s.scrollIntoView({behavior:"smooth"})},[j]),t.jsxs(t.Fragment,{children:[t.jsx(ie,{}),t.jsxs("div",{className:"grid grid-cols-12 h-full bg-background-two",children:[t.jsx("div",{className:"col-span-3 px-1 py-1"}),t.jsx("div",{className:"col-span-12 md:col-span-6 bg-gray-800 rounded-md",children:t.jsxs("div",{className:"flex flex-col items-center justify-center w-full min-h-screen text-gray-800 rounded",children:[t.jsx("div",{className:"w-full",id:"chat_header",children:k.map((s,o)=>t.jsx(t.Fragment,{children:t.jsxs("div",{className:"flex",children:[t.jsx(X,{conversation:s,currentUser:e,index:o}),t.jsxs("div",{className:"flex justify-center items-center px-4",children:[(e==null?void 0:e.role)==="mentee"&&t.jsx(T,{to:`/video/${p}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:t.jsx(U,{})}),(e==null?void 0:e.role)==="mentor"&&t.jsx(t.Fragment,{children:t.jsx(T,{to:`/video/${v}`,className:"border rounded-md text-gray-400 bg-gray-900 px-4 py-4",target:"_blank",children:t.jsx(U,{})})})]})]},o)}))}),t.jsx("div",{id:"imoji-picker",children:N&&t.jsx(Z,{onEmojiClick:O})}),t.jsxs("div",{className:"flex flex-col flex-grow w-full bg-green shadow-xl rounded-lg overflow-hidden",children:[t.jsx("div",{className:"flex flex-col flex-grow h-0 p-4 overflow-auto",children:j.map((s,o)=>t.jsx("div",{ref:I,children:t.jsx(ee,{message:s,own:(s==null?void 0:s.senderId)===(e==null?void 0:e._id),index:o,currentChat:a,userId:e==null?void 0:e._id})},o))}),R?t.jsxs("div",{className:"bg-gray-100 border-2 flex justify-center px-3 py-3",children:[t.jsx("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),t.jsx("span",{className:"px-2 cursor-pointer",onClick:Y,children:t.jsx(se,{className:"border-2 rounded"})})]}):"",t.jsxs("div",{className:"flex items-center px-1 w-full mb-4",children:[t.jsxs("div",{className:"px-2 hover:bg-gray-300 rounded-full",children:[t.jsx("span",{className:"hidden",children:t.jsx("input",{type:"file",src:h||"",id:"imageFile",onChange:D})}),t.jsx("span",{onClick:()=>{var s;(s=document.getElementById("imageFile"))==null||s.click()},children:t.jsx(te,{className:"text-gray-400"})})]}),t.jsx("input",{type:"text",id:"messageInput",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2 bg-gray-800 text-white",value:u,onChange:s=>b(s.target.value)}),t.jsx("div",{children:t.jsx("span",{className:"px-2 py-2",onClick:L,id:"imoji-btn",children:t.jsx(ae,{className:"text-gray-400"})})}),t.jsx("div",{className:"bg-gray-800 rounded-r h-10 flex items-center px-2 cursor-pointer hover:bg-slate-300",onClick:F,children:t.jsx(oe,{className:"text-gray-400"})})]})]})]})}),t.jsx("div",{className:"col-span-3"})]})]})};export{we as default};
