import{r as i,S as V,d as q,a as z,R as G,j as a,e as f,F as H,f as j,n as J,g as K,o as Q,s as M}from"./index-KMt4GyZR.js";import{C as W,E as X,M as Z,d as ee,a as se,b as te,c as ae}from"./Close-36jYy_oO.js";/* empty css                     */import"./generateUtilityClasses-uenfLlvp.js";import"./emotion-react.browser.esm-JPhz0Z0r.js";import"./createSvgIcon-Mc0KNlAg.js";import"./createSvgIcon-LhbiN6g9.js";import"./useTimeout-8sSUz1ZL.js";import"./ownerWindow-xumU0TJh.js";import"./sweetalert2.all-W_mkf_Vb.js";import"./index-C3T8pH5V.js";const he=()=>{const l=i.useContext(V),r=q(),[v,B]=i.useState([]),[o,P]=i.useState(),{user:s}=z(e=>e.userAuth),[y,x]=i.useState([]),[h,w]=i.useState(""),[p,R]=i.useState(null),E=G.useRef(null),[b,S]=i.useState(!1),[k,I]=i.useState(),[m,A]=i.useState("");i.useEffect(()=>{var e;(e=l==null?void 0:l.current)==null||e.on("getMessage",t=>{R(t)})},[l]),i.useEffect(()=>{(async()=>{try{const e=await r.get("chat/conversation",{withCredentials:!0});B(e.data.conversation)}catch(e){console.log(e)}})()},[r]);const $=async e=>{try{if(e.members&&Array.isArray(e.members)){const t=e==null?void 0:e.members.find(c=>c!==(s==null?void 0:s._id));t!==void 0?(await r.post("chat/conversation",{receiverId:t,senderId:s==null?void 0:s._id},{withCredentials:!0}),P(e)):console.log("No mentee found.")}else console.log("conversation.members is undefined or not an array.")}catch(t){console.log(t)}};i.useEffect(()=>{(async()=>{var e;try{const t=await r.get(`chat/allConversation/${o==null?void 0:o._id}`);(e=t.data)!=null&&e.allMessages&&x(t.data.allMessages)}catch(t){console.log(t)}})()},[v,r,s==null?void 0:s._id,o==null?void 0:o._id]),i.useEffect(()=>{p&&(o!=null&&o.members.includes(p==null?void 0:p.senderId))&&x(e=>[...e,p])},[p,v,o==null?void 0:o.members]);const F=async e=>{var t,c,N;if(e.preventDefault(),!(!h&&!m)){if(k&&m){const d=o==null?void 0:o.members.find(n=>n!==(s==null?void 0:s._id));if(d!==void 0){(t=l==null?void 0:l.current)==null||t.emit("sendMessage",{senderId:s==null?void 0:s._id,receiverId:d,text:m,type:"image"});try{const n={senderId:s==null?void 0:s._id,text:m,conversationId:o==null?void 0:o._id,type:"image"},g=await r.post("chat/message",n,{withCredentials:!0});x([...y,g.data.savedMessage]),w(""),I(!1)}catch(n){console.log(n)}}else console.log("No reciverId found.")}if(h){const d=o==null?void 0:o.members.find(n=>n!==(s==null?void 0:s._id));if(d!==void 0){(c=l==null?void 0:l.current)==null||c.emit("sendMessage",{senderId:s==null?void 0:s._id,receiverId:d,text:h,type:"text"});try{const n={senderId:s==null?void 0:s._id,text:h,conversationId:o==null?void 0:o._id,type:"text"},g=await r.post("chat/message",n,{withCredentials:!0});x([...y,g.data.savedMessage]),w(""),I(!1)}catch(n){console.log(n)}}else console.log("No reciverId found.")}try{const d=o==null?void 0:o.members.find(u=>u!==(s==null?void 0:s._id)),n={userId:d,content:"You have one new Message ðŸ””",role:"mentee",messageType:"new chat",senderId:s==null?void 0:s._id};await r.post(`/notification/chatNotification/${s==null?void 0:s._id}`,{ChatMessage:n},{withCredentials:!0})?(N=l==null?void 0:l.current)==null||N.emit("sendNotification",{senderId:s==null?void 0:s._id,receiverId:d,content:"You have a new message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(d){console.log(d)}}};i.useEffect(()=>{var e;(e=E.current)==null||e.scrollIntoView({behavior:"smooth"})},[y]);const O=e=>{const t=e.emoji;t?w(c=>c+t):console.log("emoji is not available")},D=()=>{S(e=>!e)},C=e=>{const t=document.getElementById("imoji-btn"),c=document.getElementById("imoji-picker");t&&c&&!t.contains(e.target)&&!c.contains(e.target)&&S(!1)};i.useEffect(()=>(b&&window.addEventListener("click",C),()=>{window.removeEventListener("click",C)}),[b]);const L=async e=>{var t;if(e.target.files){const c=e.target.files[0],N=new Blob([c],{type:c.type}),d=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),n=j(M,d),g=await J(n,N);if(g){const u=(t=g.metadata)==null?void 0:t.fullPath;if(A(u),u){const U=j(M,u);I(!0),K(U).then(_=>{const Y=document.getElementById("chat_img_main");Y.src=_}).catch(_=>{console.log(_)})}}e.target.value=""}},T=()=>{const e=j(M,m);Q(e).then(()=>{I(!1)}).catch(t=>{console.log("Error Occured",t)})};return a(H,{children:f("div",{className:"grid grid-cols-12 h-full md:h-screen px-3 py-15 bg-background-two",children:[a("div",{className:"col-span-full md:col-span-3 px-1 py-1",children:f("div",{className:"w-full overflow-y-scroll",id:"chat_header",children:[a("div",{className:"rounded-full",children:a("h1",{className:"text-center text-xl font-bold text-white",children:"Mentees"})}),v.map((e,t)=>(console.log(v),a("div",{onClick:()=>$(e),className:"mt-3 cursor-pointer",children:a(W,{conversation:e,currentUser:s,index:t})},t)))]})}),a("div",{className:"col-span-12 md:col-span-9 bg-gray-800 h-full rounded-md",children:f("div",{className:"flex flex-col items-center justify-center w-full h-screen text-gray-800 rounded relative",children:[a("div",{className:"w-full absolute",children:a("div",{id:"imoji-picker",children:b&&a(X,{onEmojiClick:O})})}),a("div",{className:"flex flex-col flex-grow w-full shadow-xl rounded-lg overflow-hidden h-96 py-8 px-1",children:o?f("div",{children:[a("div",{className:"flex flex-col flex-grow p-4 overflow-auto h-screen",children:y.map((e,t)=>a("div",{ref:E,children:a(Z,{message:e,own:(e==null?void 0:e.senderId)===(s==null?void 0:s._id),index:t,currentChat:o,userId:s==null?void 0:s._id})},t))}),k&&f("div",{className:"bg-gray-800 flex justify-center px-3 py-3",children:[a("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),a("span",{className:"px-2 cursor-pointer",onClick:T,children:a(ee,{className:"border-2 rounded text-gray-400"})})]}),f("div",{className:"flex items-center px-1 w-full",children:[f("div",{className:"px-1 hover:bg-gray-900 rounded-full",children:[a("span",{className:"hidden",children:a("input",{type:"file",src:m||"",id:"imageFile",onChange:L})}),a("span",{onClick:()=>{var e;(e=document.getElementById("imageFile"))==null||e.click()},children:a(se,{className:"text-gray-400"})})]}),a("input",{type:"text",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2 bg-gray-800 text-white",value:h,onChange:e=>w(e.target.value)}),a("div",{children:a("span",{className:"px-2 py-2 cursor-pointer",id:"imoji-btn",onClick:D,children:a(te,{className:"text-gray-400"})})}),a("div",{className:"bg-gray-800 rounded-r h-10 flex items-center px-2 cursor-pointer",onClick:F,children:a(ae,{className:"text-gray-400"})})]})]}):a("div",{className:"text-center mt-10",children:a("span",{className:"font-bold text-xl text-gray-400",children:"Please Select a chat to start messaging"})})})]})}),a("div",{className:"col-span-3"})]})})};export{he as default};
