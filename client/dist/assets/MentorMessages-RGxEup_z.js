import{r as i,S as Y,d as V,a as q,R as z,j as t,e as N,f as G,g as H,n as J,s as _}from"./index-86Yayage.js";import{C as K,E as Q,M as W,d as X,a as Z,b as ee,c as se}from"./Close-n24oJFsg.js";import{N as te}from"./Navbar-0-KNhTVm.js";/* empty css                     */import"./generateUtilityClasses-VEjm-6px.js";import"./createSvgIcon-zHam7nvJ.js";import"./createSvgIcon-yiNXXGgx.js";import"./useTimeout-HibEo2wx.js";import"./ownerWindow-X7CmOzzf.js";import"./sweetalert2.all-8kJa4Vly.js";import"./index--BIcSTSf.js";import"./Toast-dXC0qYzS.js";import"./index-f5koxsUU.js";const he=()=>{const l=i.useContext(Y),d=V(),[w,C]=i.useState([]),[o,B]=i.useState(),{user:s}=q(e=>e.userAuth),[h,j]=i.useState([]),[p,u]=i.useState(""),[f,R]=i.useState(null),E=z.useRef(null),[b,M]=i.useState(!1),[S,v]=i.useState(),[m,P]=i.useState("");i.useEffect(()=>{var e;(e=l==null?void 0:l.current)==null||e.on("getMessage",a=>{R(a)})},[l]),i.useEffect(()=>{(async()=>{try{const e=await d.get("chat/conversation",{withCredentials:!0});C(e.data.conversation)}catch(e){console.log(e)}})()},[d]);const A=async e=>{try{if(e.members&&Array.isArray(e.members)){const a=e==null?void 0:e.members.find(c=>c!==(s==null?void 0:s._id));a!==void 0?(await d.post("chat/conversation",{receiverId:a,senderId:s==null?void 0:s._id},{withCredentials:!0}),B(e)):console.log("No mentee found.")}else console.log("conversation.members is undefined or not an array.")}catch(a){console.log(a)}};i.useEffect(()=>{(async()=>{var e;try{const a=await d.get(`chat/allConversation/${o==null?void 0:o._id}`);(e=a.data)!=null&&e.allMessages&&j(a.data.allMessages)}catch(a){console.log(a)}})()},[w,d,s==null?void 0:s._id,o==null?void 0:o._id]),i.useEffect(()=>{f&&(o!=null&&o.members.includes(f==null?void 0:f.senderId))&&j(e=>[...e,f])},[f,w,o==null?void 0:o.members]);const $=async e=>{var a,c,y;if(e.preventDefault(),!(!p&&!m)){if(S&&m){const r=o==null?void 0:o.members.find(n=>n!==(s==null?void 0:s._id));if(r!==void 0){(a=l==null?void 0:l.current)==null||a.emit("sendMessage",{senderId:s==null?void 0:s._id,receiverId:r,text:m,type:"image"});try{const n={senderId:s==null?void 0:s._id,text:m,conversationId:o==null?void 0:o._id,type:"image"},g=await d.post("chat/message",n,{withCredentials:!0});j([...h,g.data.savedMessage]),u(""),v(!1)}catch(n){console.log(n)}}else console.log("No reciverId found.")}if(p){const r=o==null?void 0:o.members.find(n=>n!==(s==null?void 0:s._id));if(r!==void 0){(c=l==null?void 0:l.current)==null||c.emit("sendMessage",{senderId:s==null?void 0:s._id,receiverId:r,text:p,type:"text"});try{const n={senderId:s==null?void 0:s._id,text:p,conversationId:o==null?void 0:o._id,type:"text"},g=await d.post("chat/message",n,{withCredentials:!0});j([...h,g.data.savedMessage]),u(""),v(!1)}catch(n){console.log(n)}}else console.log("No reciverId found.")}try{const r=o==null?void 0:o.members.find(x=>x!==(s==null?void 0:s._id)),n={userId:r,content:"You have one new Message ðŸ””",role:"mentee",messageType:"new chat",senderId:s==null?void 0:s._id};await d.post(`/notification/chatNotification/${s==null?void 0:s._id}`,{ChatMessage:n},{withCredentials:!0})?(y=l==null?void 0:l.current)==null||y.emit("sendNotification",{senderId:s==null?void 0:s._id,receiverId:r,content:"You have a new message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(r){console.log(r)}}};i.useEffect(()=>{var e;(e=E.current)==null||e.scrollIntoView({behavior:"smooth"})},[h]);const O=e=>{const a=e.emoji;a?u(c=>c+a):console.log("emoji is not available")},D=()=>{M(e=>!e)},k=e=>{const a=document.getElementById("imoji-btn"),c=document.getElementById("imoji-picker");a&&c&&!a.contains(e.target)&&!c.contains(e.target)&&M(!1)};i.useEffect(()=>(b&&window.addEventListener("click",k),()=>{window.removeEventListener("click",k)}),[b]);const F=async e=>{var a;if(e.target.files){const c=e.target.files[0],y=new Blob([c],{type:c.type}),r=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),n=N(_,r),g=await G(n,y);if(g){const x=(a=g.metadata)==null?void 0:a.fullPath;if(P(x),x){const T=N(_,x);v(!0),H(T).then(I=>{const U=document.getElementById("chat_img_main");U.src=I}).catch(I=>{console.log(I)})}}e.target.value=""}},L=()=>{const e=N(_,m);J(e).then(()=>{v(!1)}).catch(a=>{console.log("Error Occured",a)})};return t.jsxs(t.Fragment,{children:[t.jsx(te,{}),t.jsxs("div",{className:"grid grid-cols-12 h-full md:h-screen px-3 py-15 bg-background-two",children:[t.jsx("div",{className:"col-span-full md:col-span-3 px-1 py-1",children:t.jsxs("div",{className:"w-full overflow-y-scroll",id:"chat_header",children:[t.jsx("div",{className:"rounded-full",children:t.jsx("h1",{className:"text-center text-xl font-bold text-white",children:"Mentees"})}),w.map((e,a)=>t.jsx("div",{onClick:()=>A(e),className:"mt-3 cursor-pointer",children:t.jsx(K,{conversation:e,currentUser:s,index:a})},a))]})}),t.jsx("div",{className:"col-span-12 md:col-span-9 bg-gray-800 rounded-md",children:t.jsxs("div",{className:"flex flex-col items-center justify-center w-full min-h-full text-gray-800 rounded relative",children:[t.jsx("div",{className:"w-full absolute bottom-15",children:t.jsx("div",{id:"imoji-picker",children:b&&t.jsx(Q,{onEmojiClick:O})})}),t.jsx("div",{className:"flex flex-col flex-grow w-full shadow-xl rounded-lg overflow-hidden h-96 py-8 px-1",children:o?t.jsxs("div",{children:[t.jsx("div",{className:"flex flex-col flex-grow p-4 overflow-auto h-screen",children:h.map((e,a)=>t.jsx("div",{ref:E,children:t.jsx(W,{message:e,own:(e==null?void 0:e.senderId)===(s==null?void 0:s._id),index:a,currentChat:o,userId:s==null?void 0:s._id})},a))}),S?t.jsxs("div",{className:"bg-gray-800 flex justify-center px-3 py-3",children:[t.jsx("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),t.jsx("span",{className:"px-2 cursor-pointer",onClick:L,children:t.jsx(X,{className:"border-2 rounded text-gray-400"})})]}):"",t.jsxs("div",{className:"flex items-center px-1 w-full mb-4",children:[t.jsxs("div",{className:"px-2 hover:bg-gray-900 rounded-full",children:[t.jsx("span",{className:"hidden",children:t.jsx("input",{type:"file",src:m||"",id:"imageFile",onChange:F})}),t.jsx("span",{onClick:()=>{var e;(e=document.getElementById("imageFile"))==null||e.click()},children:t.jsx(Z,{className:"text-gray-400"})})]}),t.jsx("input",{type:"text",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2 bg-gray-800 text-white",value:p,onChange:e=>u(e.target.value)}),t.jsx("div",{children:t.jsx("span",{className:"px-2 py-2 cursor-pointer",id:"imoji-btn",onClick:D,children:t.jsx(ee,{className:"text-gray-400"})})}),t.jsx("div",{className:"bg-gray-800 rounded-r h-10 flex items-center px-2 cursor-pointer",onClick:$,children:t.jsx(se,{className:"text-gray-400"})})]})]}):t.jsx("div",{className:"text-center mt-10",children:t.jsxs("span",{className:"font-bold text-xl text-gray-400",children:["Please Select a chat to start messaging",t.jsx("img",{src:"https://www.csr-online.net/wp-content/uploads/2020/06/people-speech-bubbles-chatting-communication-concept-vector-illustration-141568372-450x350.jpg",alt:""})]})})})]})}),t.jsx("div",{className:"col-span-3"})]})]})};export{he as default};
