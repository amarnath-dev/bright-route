import{d as Y,r as n,a as H,R as V,p as q,j as t,e as N,f as z,g as G,n as J,s as _}from"./index-3TceeTOD.js";import{C as K,E as Q,M as W,d as X,a as Z,b as ee,c as se}from"./Close-Vf-LoMuY.js";import{N as te}from"./Navbar-XOTjCJtn.js";/* empty css                     */import"./generateUtilityClasses-lap0UWya.js";import"./createSvgIcon-GwF7MXM7.js";import"./createSvgIcon-SrMR24XR.js";import"./useTimeout-nvZZxNHc.js";import"./ownerWindow-J0v5-7PB.js";import"./sweetalert2.all-KwTCPX7N.js";import"./index-vkJcP6vC.js";import"./Toast-Zzs0v0Ml.js";import"./index-fdt_ya2m.js";const oe="http://localhost:3000",ue=()=>{const r=Y(),[w,C]=n.useState([]),[a,R]=n.useState(),{user:s}=H(e=>e.userAuth),[h,u]=n.useState([]),[p,j]=n.useState(""),[f,B]=n.useState(null),M=V.useRef(null),d=n.useRef(null),[b,k]=n.useState(!1),[E,v]=n.useState(),[m,P]=n.useState("");n.useEffect(()=>{var e;d.current=q(oe),(e=d.current)==null||e.on("getMessage",o=>{B(o)})},[]),n.useEffect(()=>{(async()=>{try{const o=await r.get("chat/conversation",{withCredentials:!0});C(o.data.conversation)}catch(o){console.log(o)}})()},[r]);const A=async e=>{try{if(e.members&&Array.isArray(e.members)){const o=e==null?void 0:e.members.find(c=>c!==(s==null?void 0:s._id));o!==void 0?(await r.post("chat/conversation",{receiverId:o,senderId:s==null?void 0:s._id},{withCredentials:!0}),R(e)):console.log("No mentee found.")}else console.log("conversation.members is undefined or not an array.")}catch(o){console.log(o)}};n.useEffect(()=>{try{(async()=>{const o=await r.get(`chat/allConversation/${a==null?void 0:a._id}`);o.data.allMessages&&u(o.data.allMessages)})()}catch(e){console.log(e)}},[w,r,s==null?void 0:s._id,a==null?void 0:a._id]),n.useEffect(()=>{f&&(a!=null&&a.members.includes(f==null?void 0:f.senderId))&&u(e=>[...e,f])},[f,w,a==null?void 0:a.members]),n.useEffect(()=>{var e,o;(e=d.current)==null||e.emit("addUser",s==null?void 0:s._id),(o=d.current)==null||o.on("getUsers",c=>{console.log(c)})},[s,d]);const U=async e=>{var o,c,y;if(e.preventDefault(),!(!p&&!m)){if(E&&m){const l=a==null?void 0:a.members.find(i=>i!==(s==null?void 0:s._id));if(l!==void 0){(o=d.current)==null||o.emit("sendMessage",{senderId:s==null?void 0:s._id,receiverId:l,text:m,type:"image"});try{const i={senderId:s==null?void 0:s._id,text:m,conversationId:a==null?void 0:a._id,type:"image"},g=await r.post("chat/message",i,{withCredentials:!0});u([...h,g.data.savedMessage]),j(""),v(!1)}catch(i){console.log(i)}}else console.log("No reciverId found.")}if(p){const l=a==null?void 0:a.members.find(i=>i!==(s==null?void 0:s._id));if(l!==void 0){(c=d.current)==null||c.emit("sendMessage",{senderId:s==null?void 0:s._id,receiverId:l,text:p,type:"text"});try{const i={senderId:s==null?void 0:s._id,text:p,conversationId:a==null?void 0:a._id,type:"text"},g=await r.post("chat/message",i,{withCredentials:!0});u([...h,g.data.savedMessage]),j(""),v(!1)}catch(i){console.log(i)}}else console.log("No reciverId found.")}try{const l=a==null?void 0:a.members.find(x=>x!==(s==null?void 0:s._id)),i={userId:l,content:"You have one new Message!!ðŸ””",role:"mentee",messageType:"new chat",senderId:s==null?void 0:s._id};await r.post(`/notification/chatNotification/${s==null?void 0:s._id}`,{ChatMessage:i},{withCredentials:!0})?(y=d.current)==null||y.emit("sendNotification",{senderId:s==null?void 0:s._id,receiverId:l,content:"You have a new message ðŸ””",type:"chat message"}):console.log("Chat notification send failed")}catch(l){console.log(l)}}};n.useEffect(()=>{var e;(e=M.current)==null||e.scrollIntoView({behavior:"smooth"})},[h]);const $=e=>{const o=e.emoji;o?j(c=>c+o):console.log("emoji is not available")},O=()=>{k(e=>!e)},S=e=>{const o=document.getElementById("imoji-btn"),c=document.getElementById("imoji-picker");o&&c&&!o.contains(e.target)&&!c.contains(e.target)&&k(!1)};n.useEffect(()=>(b&&window.addEventListener("click",S),()=>{window.removeEventListener("click",S)}),[b]);const T=async e=>{var o;if(e.target.files){const c=e.target.files[0],y=new Blob([c],{type:c.type}),l=Math.random().toString(16).slice(2)+(new Date().getTime()/1e3).toString(),i=N(_,l),g=await z(i,y);if(g){const x=(o=g.metadata)==null?void 0:o.fullPath;if(P(x),x){const F=N(_,x);v(!0),G(F).then(I=>{const L=document.getElementById("chat_img_main");L.src=I}).catch(I=>{console.log(I)})}}e.target.value=""}},D=()=>{const e=N(_,m);J(e).then(()=>{v(!1)}).catch(o=>{console.log("Error Occured",o)})};return t.jsxs(t.Fragment,{children:[t.jsx(te,{}),t.jsxs("div",{className:"grid grid-cols-12 h-full md:h-screen px-3 py-15 bg-background-two",children:[t.jsx("div",{className:"col-span-full md:col-span-3 px-1 py-1",children:t.jsxs("div",{className:"w-full overflow-y-scroll",id:"chat_header",children:[t.jsx("div",{className:"rounded-full",children:t.jsx("h1",{className:"text-center text-xl font-bold text-white",children:"Mentees"})}),w.map((e,o)=>t.jsx("div",{onClick:()=>A(e),className:"mt-3 cursor-pointer",children:t.jsx(K,{conversation:e,currentUser:s,index:o})},o))]})}),t.jsx("div",{className:"col-span-12 md:col-span-9 bg-gray-800 rounded-md",children:t.jsxs("div",{className:"flex flex-col items-center justify-center w-full min-h-full text-gray-800 rounded relative",children:[t.jsx("div",{className:"w-full absolute bottom-15 left-36",children:t.jsx("div",{id:"imoji-picker",children:b&&t.jsx(Q,{onEmojiClick:$})})}),t.jsx("div",{className:"flex flex-col flex-grow w-full shadow-xl rounded-lg overflow-hidden h-96 py-8 px-1",children:a?t.jsxs("div",{children:[t.jsx("div",{className:"flex flex-col flex-grow p-4 overflow-auto h-screen",children:h.map((e,o)=>t.jsx("div",{ref:M,children:t.jsx(W,{message:e,own:(e==null?void 0:e.senderId)===(s==null?void 0:s._id),index:o,currentChat:a,userId:s==null?void 0:s._id})},o))}),E?t.jsxs("div",{className:"bg-gray-800 flex justify-center px-3 py-3",children:[t.jsx("img",{id:"chat_img_main",src:"",className:"object-cover h-40"}),t.jsx("span",{className:"px-2 cursor-pointer",onClick:D,children:t.jsx(X,{className:"border-2 rounded text-gray-400"})})]}):"",t.jsxs("div",{className:"flex items-center px-1 w-full mb-4",children:[t.jsxs("div",{className:"px-2 hover:bg-gray-900 rounded-full",children:[t.jsx("span",{className:"hidden",children:t.jsx("input",{type:"file",src:m||"",id:"imageFile",onChange:T})}),t.jsx("span",{onClick:()=>{var e;(e=document.getElementById("imageFile"))==null||e.click()},children:t.jsx(Z,{className:"text-gray-400"})})]}),t.jsx("input",{type:"text",placeholder:"Type a message...",className:"w-full rounded-l h-10 pl-2 bg-gray-800 text-white",value:p,onChange:e=>j(e.target.value)}),t.jsx("div",{children:t.jsx("span",{className:"px-2 py-2 cursor-pointer",id:"imoji-btn",onClick:O,children:t.jsx(ee,{className:"text-gray-400"})})}),t.jsx("div",{className:"bg-gray-800 rounded-r h-10 flex items-center px-2 cursor-pointer",onClick:U,children:t.jsx(se,{className:"text-gray-400"})})]})]}):t.jsx("div",{className:"text-center mt-10",children:t.jsxs("span",{className:"font-bold text-xl text-gray-400",children:["Please Select a chat to start messaging",t.jsx("img",{src:"https://www.csr-online.net/wp-content/uploads/2020/06/people-speech-bubbles-chatting-communication-concept-vector-illustration-141568372-450x350.jpg",alt:""})]})})})]})}),t.jsx("div",{className:"col-span-3"})]})]})};export{ue as default};
